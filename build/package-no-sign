#!/usr/bin/env bash

# This packages helm charts into tarballs

# make bash play nicely
#
set -o pipefail -o errtrace -o errexit -o nounset
shopt -s inherit_errexit
[[ -n "${TRACE:-}" ]] && set -o xtrace

# Local env vars
#
S3_UPLOAD_TO_SUB_FOLDER="${S3_SUB_FOLDER:-neo4j}"

NEO4J_VERSION_TC="${NEO4JVERSION1}"

[ -z "$NEO4J_VERSION_TC" ] && echo "env.NEO4JVERSION cannot be empty" && exit 1

NEO4J_VERSION=$(echo "${NEO4J_VERSION_TC}" | awk -F "-" '{print $1}')
echo "NEO4J VERSION := ${NEO4J_VERSION}"

# Create packages!
mkdir -p ./packages

# create neo4j-shared-templates with updated app-version and replace the older neo4j-shared-templates with the new one
helm package ./neo4j-shared-templates --app-version="${NEO4J_VERSION}" --destination ./packages
rm -rf ./neo4j-shared-templates
tar -xvf ./packages/neo4j-shared-templates*.tgz -C ./

helm package ./neo4j-standalone --app-version="${NEO4J_VERSION}" --dependency-update --destination ./packages
helm package ./neo4j-cluster-core --app-version="${NEO4J_VERSION}" --dependency-update --destination ./packages
helm package ./neo4j-cluster-loadbalancer --app-version="${NEO4J_VERSION}" --dependency-update --destination ./packages
helm package ./neo4j-cluster-read-replica --app-version="${NEO4J_VERSION}" --dependency-update --destination ./packages
helm package ./neo4j-cluster-headless-service --app-version="${NEO4J_VERSION}" --dependency-update --destination ./packages

#remove neo4j shared templates tar as we dont want to upload it to helm repo
rm -f "./packages/neo4j-shared-templates*.tgz"

# helm package ./neo4j-docker-desktop-pv
# helm package ./neo4j-gcloud-pv

# Pull existing packages from s3
#
mkdir -p ./temp/packages
aws s3 sync s3://helm.neo4j.com/neo4j ./temp/packages
cp ./packages/* ./temp/packages/ || echo "nothing to upload in ./packages/"

# Create index.yaml
#
helm repo index ./temp/packages/ --url https://helm.neo4j.com/neo4j

# Upload new packages to s3
#
aws s3 sync --acl bucket-owner-full-control --cache-control max-age=300 ./temp/packages/ s3://helm.neo4j.com/$S3_UPLOAD_TO_SUB_FOLDER

# Clean up local packages
rm ./packages/*
